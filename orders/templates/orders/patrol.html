{% extends 'base.html' %}
{% block content %}

<div class="container py-4">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden patrol-card">
    <div class="card-header text-white text-center py-4 patrol-header">
      <div class="header-icon-wrap mx-auto mb-2">
        <i class="fas fa-shield-alt"></i>
      </div>
      <h3 class="fw-bold mb-0">Patrul Nazorati</h3>
      <div class="mt-2 small opacity-90">
        Hozirgi vaqt: {{ current_time|date:"H:i" }}
      </div>
    </div>

    <div class="card-body p-4">
      <div class="row g-3">
        {% for s in slots %}
        <div class="col-12">
          <div class="slot-card {% if s.is_active %}is-active{% else %}is-inactive{% endif %}">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="d-flex align-items-center gap-3">
                <div class="slot-icon">
                  {% if s.is_active %}
                    <i class="fas fa-bolt"></i>
                  {% else %}
                    <i class="fas fa-clock"></i>
                  {% endif %}
                </div>
                <div>
                  <div class="fw-bold fs-5 mb-0">{{ s.label }}</div>
                  <div class="small text-muted">
                    {% if s.is_active %}Hozir faol slot{% else %}Faol emas{% endif %}
                  </div>
                </div>
              </div>

              <div class="d-flex align-items-center gap-2">
                {% if s.is_completed %}
                  <span class="badge bg-success rounded-pill px-3 py-2">
                    <i class="fas fa-check-circle me-1"></i> TEKSHIRILDI
                  </span>
                {% else %}
                  <span class="badge bg-danger rounded-pill px-3 py-2">
                    <i class="fas fa-times-circle me-1"></i> TEKSHIRILMADI
                  </span>
                {% endif %}

                {% if s.is_active %}
                  <span class="badge bg-emerald rounded-pill px-3 py-2">ACTIVE</span>
                {% endif %}
              </div>
            </div>

            {% if s.is_active %}
              {% if s.is_completed %}
                <div class="mt-3 alert alert-success border-0 mb-0">
                  <i class="fas fa-check-double me-2"></i> Bu vaqt uchun bugun hisobot topshirilgan âœ…
                </div>
              {% else %}
                <hr class="my-3">
                <form id="patrolForm" method="POST" enctype="multipart/form-data">
                  {% csrf_token %}
                  <input type="hidden" name="lat" id="lat">
                  <input type="hidden" name="lng" id="lng">
                  <input type="hidden" name="slot" value="{{ s.label }}">

                  <div class="row g-3 mb-3 text-center">
                    {% for i in "1234" %}
                    <div class="col-6 col-md-3">
                      <label class="small fw-bold">Rasm {{ i }}</label>
                      <div class="upload-area mt-2">
                        <button type="button" class="file-custom-btn" data-target="img{{ i }}">
                          <i class="fas fa-camera fa-lg"></i>
                        </button>
                        <input type="file" id="img{{ i }}" name="img{{ i }}" class="form-control file-input d-none" accept="image/*" capture="environment" required>
                        <div class="preview-wrap mt-2 d-none" id="previewWrap{{ i }}">
                          <img class="preview-img" id="previewImg{{ i }}" alt="preview {{ i }}">
                          <button type="button" class="btn btn-sm btn-outline-success w-100 mt-2 retake-btn" data-target="img{{ i }}">Qayta olish</button>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>

                  <button type="submit" id="submitBtn" class="btn-patrol-submit" disabled>
                    <i class="fas fa-check-double"></i> <span>TEKSHIRDIM</span>
                  </button>
                </form>
              {% endif %}
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
  :root{
    --emerald-50:#ecfdf5; --emerald-600:#059669; --emerald-700:#047857; --slate-50:#f8fafc; --slate-200:#e2e8f0;
  }
  .patrol-header{ background: linear-gradient(135deg, var(--emerald-700) 0%, var(--emerald-600) 100%); }
  .header-icon-wrap{ width: 56px; height: 56px; border-radius: 18px; background: rgba(255,255,255,.18); display:flex; align-items:center; justify-content:center; font-size: 26px; }
  .slot-card{ border-radius: 16px; padding: 16px; border: 1px solid rgba(0,0,0,0.08); background: #fff; transition: .2s ease; }
  .slot-card.is-active{ border: 2px solid rgba(16, 185, 129, 0.35); background: linear-gradient(0deg, rgba(16,185,129,0.07), rgba(16,185,129,0.07)), #fff; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.12); }
  .slot-icon{ width: 44px; height: 44px; border-radius: 14px; display:flex; align-items:center; justify-content:center; background: rgba(16,185,129,0.14); color: var(--emerald-700); }
  .bg-emerald{ background: var(--emerald-600) !important; }
  .file-custom-btn{ width: 100%; aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; border: 2px dashed rgba(16,185,129,0.55); border-radius: 14px; color: var(--emerald-700); background: var(--emerald-50); cursor: pointer; padding: 0; }
  .file-custom-btn.filled{ border-style: solid; background: var(--emerald-600); color: #fff; }
  .preview-img{ width: 100%; border-radius: 12px; object-fit: cover; aspect-ratio: 1/1; border: 1px solid var(--slate-200); }
  .btn-patrol-submit{ width: 100%; padding: 16px; border: none; border-radius: 14px; color: white; font-weight: 800; background: #d1d5db; cursor: not-allowed; }
  .btn-patrol-submit.active{ background: linear-gradient(135deg, var(--emerald-700) 0%, var(--emerald-600) 100%); cursor: pointer; }
</style>

<script>
async function addWatermarkToFile(file) {
  const MAX_W = 1024; // RAMni tejash uchun o'lchamni kichraytirdik
  const QUALITY = 0.75; 

  const bitmap = await createImageBitmap(file);
  const w = bitmap.width;
  const h = bitmap.height;
  const scale = Math.min(1, MAX_W / w);
  const nw = Math.round(w * scale);
  const nh = Math.round(h * scale);

  const canvas = document.createElement("canvas");
  canvas.width = nw;
  canvas.height = nh;
  const ctx = canvas.getContext("2d", { alpha: false });
  ctx.drawImage(bitmap, 0, 0, nw, nh);
  
  // BITMAPNI DARHOL YOPAMIZ (RAMni bo'shatish)
  bitmap.close(); 

  const now = new Date();
  const dateStr = now.toLocaleDateString("uz-UZ");
  const timeStr = now.toLocaleTimeString("uz-UZ", { hour: "2-digit", minute: "2-digit" });

  const text1 = "ECO PROM";
  const text2 = `${dateStr} ${timeStr}`;
  const fontSize = Math.max(18, Math.floor(nw * 0.045));
  const padding = Math.floor(nw * 0.02);

  ctx.fillStyle = "rgba(0,0,0,0.5)";
  ctx.fillRect(0, nh - (fontSize * 2.5), nw * 0.4, fontSize * 2.5);
  ctx.fillStyle = "#fff";
  ctx.font = `800 ${fontSize}px Arial`;
  ctx.fillText(text1, padding, nh - fontSize * 1.2);
  ctx.font = `600 ${fontSize * 0.7}px Arial`;
  ctx.fillText(text2, padding, nh - padding);

  const blob = await new Promise((res) => canvas.toBlob(res, "image/jpeg", QUALITY));
  
  // CANVASNI TOZALASH
  canvas.width = 0; canvas.height = 0;

  return new File([blob], file.name.replace(/\.\w+$/, "") + ".jpg", { type: "image/jpeg" });
}

const btn = document.getElementById('submitBtn');
const inputs = document.querySelectorAll('.file-input');

function updateSubmitState() {
  if (!btn) return;
  const allFilled = Array.from(inputs).every(i => i.files && i.files.length > 0);
  btn.disabled = !allFilled;
  allFilled ? btn.classList.add('active') : btn.classList.remove('active');
}

if (btn && inputs.length) {
  navigator.geolocation.getCurrentPosition(p => {
    document.getElementById('lat').value = p.coords.latitude;
    document.getElementById('lng').value = p.coords.longitude;
  });

  document.querySelectorAll('.file-custom-btn, .retake-btn').forEach(b => {
    b.addEventListener('click', () => document.getElementById(b.dataset.target).click());
  });

  inputs.forEach(input => {
    input.addEventListener('change', async function() {
      if (!this.files.length) return;
      const label = this.parentElement.querySelector('.file-custom-btn');
      label.classList.add('filled');
      label.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      
      try {
        const wmFile = await addWatermarkToFile(this.files[0]);
        const dt = new DataTransfer();
        dt.items.add(wmFile);
        this.files = dt.files;

        const idx = this.id.replace('img','');
        document.getElementById(`previewImg${idx}`).src = URL.createObjectURL(wmFile);
        document.getElementById(`previewWrap${idx}`).classList.remove('d-none');
        label.innerHTML = '<i class="fas fa-check"></i>';
      } catch (e) {
        alert("Xatolik: Xotira yetmadi. Brauzer varaqlarni yopib qayta urinib ko'ring.");
        label.innerHTML = '<i class="fas fa-camera"></i>';
      }
      updateSubmitState();
    });
  });
}
</script>
{% endblock %}
