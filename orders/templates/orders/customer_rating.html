{% extends "orders/base.html" %}
{% load humanize %}

{% block content %}
<div class="container mt-4 mb-5">
    <!-- Sarlavha qismi -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white border-0 shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="mb-2"><i class="fas fa-trophy me-3"></i>Mijozlar Reytingi</h1>
                            <p class="mb-0 opacity-75">Har bir mijozning buyurtmalari bo'yicha reyting jadvali</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-white text-primary fs-6 p-3">
                                <i class="fas fa-users me-2"></i>Jami: {{ ratings|length }} mijoz
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reyting kartalar -->
    <div class="row mb-4">
        {% for item in ratings|slice:":3" %}
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100 hover-shadow transition-all" onclick="showCustomerOrders('{{ item.customer_unique_id }}', '{{ item.display_name }}')" style="cursor: pointer;">
                <div class="card-body p-4 text-center">
                    <div class="position-relative mb-3">
                        {% if forloop.counter == 1 %}
                        <div class="trophy-badge bg-warning text-dark">
                            <i class="fas fa-crown fa-2x"></i>
                        </div>
                        {% elif forloop.counter == 2 %}
                        <div class="trophy-badge bg-secondary text-white">
                            <i class="fas fa-medal fa-2x"></i>
                        </div>
                        {% elif forloop.counter == 3 %}
                        <div class="trophy-badge bg-danger text-white">
                            <i class="fas fa-award fa-2x"></i>
                        </div>
                        {% endif %}
                    </div>
                    
                    <h3 class="text-primary mb-2">{{ item.display_name|default:"Noma'lum" }}</h3>
                    <p class="text-muted mb-3">ID: #{{ item.customer_unique_id }}</p>
                    
                    <div class="d-flex justify-content-center gap-4 mb-3">
                        <div class="text-center">
                            <span class="d-block fs-4 fw-bold text-info">{{ item.order_count }}</span>
                            <small class="text-muted">Buyurtma</small>
                        </div>
                        <div class="text-center">
                            <span class="d-block fs-4 fw-bold text-success">{{ item.total_m2|floatformat:2 }}</span>
                            <small class="text-muted">m²</small>
                        </div>
                    </div>
                    
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-gradient-info" style="width: {% widthratio item.total_m2 ratings.0.total_m2 100 %}%"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Asosiy jadval -->
    <div class="card border-0 shadow-lg">
        <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-dark">
                    <i class="fas fa-list-ol me-2 text-primary"></i>To'liq Reyting Jadvali
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                    <a href="{% url 'order_list' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>Orqaga
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4 text-center" style="width: 80px;">O'rin</th>
                            <th>Mijoz</th>
                            <th class="text-center">Buyurtmalar</th>
                            <th class="text-end pe-4">Umumiy Maydon</th>
                            <th class="text-center" style="width: 150px;">Harakatlar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in ratings %}
                        <tr class="hover-row">
                            <td class="ps-4 text-center">
                                <div class="rank-badge 
                                    {% if forloop.counter == 1 %}rank-gold
                                    {% elif forloop.counter == 2 %}rank-silver
                                    {% elif forloop.counter == 3 %}rank-bronze
                                    {% else %}rank-normal{% endif %}">
                                    {{ forloop.counter }}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-light-primary text-primary me-3">
                                        {{ item.display_name|first|default:"?" }}
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-dark">{{ item.display_name|default:"Noma'lum mijoz" }}</h6>
                                        <small class="text-muted">ID: #{{ item.customer_unique_id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge rounded-pill bg-info text-white fs-6 px-3 py-2">
                                    {{ item.order_count }}
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="d-flex align-items-center justify-content-end">
                                    <i class="fas fa-ruler-combined text-success me-2"></i>
                                    <h4 class="mb-0 fw-bold text-success">{{ item.total_m2|floatformat:2 }} <small class="fs-6">m²</small></h4>
                                </div>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="showCustomerOrders('{{ item.customer_unique_id }}', '{{ item.display_name }}')">
                                    <i class="fas fa-eye me-1"></i>Ko'rish
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <h4>Ma'lumot topilmadi</h4>
                                    <p>Hozircha mijozlar reytingi mavjud emas</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="customerOrdersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-primary text-white">
                <div class="d-flex align-items-center">
                    <div class="avatar-circle bg-white text-primary me-3">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="modalCustomerName"></h5>
                        <small>Mijozning barcha buyurtmalari</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Buyurtma raqami</th>
                                <th>Mahsulot</th>
                                <th class="text-center">Kvadrat</th>
                                <th class="text-center">Holati</th>
                                <th class="text-center">Sana</th>
                                <th class="text-center">Narxi</th>
                            </tr>
                        </thead>
                        <tbody id="modalOrdersBody">
                            <!-- Ma'lumotlar JavaScript orqali yuklanadi -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            </div>
        </div>
    </div>
</div>

<style>
.hover-shadow {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
}
.trophy-badge {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border: 5px solid white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.rank-badge {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto;
}
.rank-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
}
.rank-silver {
    background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
    color: white;
    box-shadow: 0 4px 10px rgba(192, 192, 192, 0.3);
}
.rank-bronze {
    background: linear-gradient(135deg, #CD7F32, #A0522D);
    color: white;
    box-shadow: 0 4px 10px rgba(205, 127, 50, 0.3);
}
.rank-normal {
    background: #f8f9fa;
    color: #6c757d;
    border: 2px solid #e9ecef;
}
.avatar-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
}
.bg-light-primary {
    background-color: rgba(13, 110, 253, 0.1);
}
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.bg-gradient-info {
    background: linear-gradient(90deg, #17a2b8, #20c997);
}
.hover-row:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
}
.transition-all {
    transition: all 0.3s ease;
}
.progress {
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}
@media print {
    .btn, .hover-shadow, .hover-row {
        box-shadow: none !important;
    }
    .table {
        border: 1px solid #dee2e6;
    }
}
</style>

<script>
function showCustomerOrders(customerId, customerName) {
    // Modalni tayyorlash
    const modalName = document.getElementById('modalCustomerName');
    const avatarLetter = customerName ? customerName.charAt(0).toUpperCase() : '?';
    
    modalName.innerHTML = `
        ${customerName}
        <small class="d-block opacity-75">ID: #${customerId}</small>
    `;
    
    const tbody = document.getElementById('modalOrdersBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Yuklanmoqda...</span>
                </div>
                <p class="mt-3 text-muted">Buyurtmalar yuklanmoqda...</p>
            </td>
        </tr>
    `;
    
    // Modalni ochish
    const myModal = new bootstrap.Modal(document.getElementById('customerOrdersModal'));
    myModal.show();

    // Ma'lumotlarni olish
    fetch(`/orders/get-customer-orders/${customerId}/`)
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            tbody.innerHTML = '';
            
            if (!data.orders || data.orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p class="mb-0">Buyurtmalar topilmadi</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Jami hisoblash
            let totalKvadrat = 0;
            let totalPrice = 0;
            
            data.orders.forEach(order => {
                const date = new Date(order.created_at).toLocaleDateString('ru-RU');
                const kvadrat = parseFloat(order.panel_kvadrat) || 0;
                const price = parseFloat(order.price) || 0;
                
                totalKvadrat += kvadrat;
                totalPrice += price;
                
                // Holat rangini aniqlash
                let statusClass = 'bg-secondary';
                if (order.status.includes('tugatil')) statusClass = 'bg-success';
                if (order.status.includes('jarayonda')) statusClass = 'bg-warning text-dark';
                if (order.status.includes('bekor')) statusClass = 'bg-danger';
                
                tbody.innerHTML += `
                    <tr>
                        <td class="ps-4 fw-bold text-primary">${order.order_number || '---'}</td>
                        <td>${order.product_name || '---'}</td>
                        <td class="text-center fw-bold">${kvadrat.toFixed(2)} m²</td>
                        <td class="text-center">
                            <span class="badge ${statusClass}">${order.status}</span>
                        </td>
                        <td class="text-center">${date}</td>
                        <td class="text-center fw-bold text-success">
                            ${price.toLocaleString()} so'm
                        </td>
                    </tr>
                `;
            });
            
            // Jami qator
            tbody.innerHTML += `
                <tr class="table-active fw-bold">
                    <td colspan="2" class="text-end">JAMI:</td>
                    <td class="text-center text-primary">${totalKvadrat.toFixed(2)} m²</td>
                    <td></td>
                    <td></td>
                    <td class="text-center text-success">${totalPrice.toLocaleString()} so'm</td>
                </tr>
            `;
        })
        .catch(error => {
            console.error('Xatolik:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p class="mb-0">Ma'lumot yuklashda xatolik yuz berdi</p>
                        <small>${error.message}</small>
                    </td>
                </tr>
            `;
        });
}
</script>
{% endblock %}
